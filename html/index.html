<html>
	<head>
		<title>FFMPEG to WebRTC demo</title>
		<style>
			#remoteVideos {
				background-color: black;
				text-align: center;
				width: 100%;
				height: 100%;
				/* display: flex; */
				/* align-items: center; */
				/* justify-content: center; */
			}

			#remoteVideos video {
				width: 100%;
				height: 100%;
				object-fit: contain;
			}

			#remoteVideos h1 {
				color: white;
			}

		</style>
	</head>
		<script>
				/* eslint-env browser */
				let pc = new RTCPeerConnection({
				  iceServers: [{
					urls: 'stun:stun.l.google.com:19302'
				  }]
				})
				let log = msg => {
					console.log(msg);
				}

				let hasOffer = false;
				let hasCandidate = false;
				let started = false;

				pc.ontrack = function(event) {
					log("ontrack")
					var el = document.createElement(event.track.kind)
					el.srcObject = event.streams[0]
					el.autoplay = true
					el.controls = true

					setTimeout(() => {
						document.getElementById('remoteVideos').appendChild(el);
						document.getElementById('loading').remove();
					}, 1000);
				}

				pc.oniceconnectionstatechange = e => log(`Conn state: ${pc.iceConnectionState}`);
				pc.onicecandidate = event => {
					hasCandidate = true;
					maybeStart();
					log("onicecandidate");
				}

				// Offer to receive 1 audio, and 1 video track
				pc.addTransceiver('video', {
				  'direction': 'sendrecv'
				})
				pc.addTransceiver('audio', {
				  'direction': 'sendrecv'
				})

				pc.createOffer()
					.then(d => pc.setLocalDescription(d))
					.then(() => {
						log('Ready');
						hasOffer = true;
						maybeStart();
					})
					.catch(log);

				const maybeStart = () => {
					if (hasOffer && hasCandidate && !started) {
						started = true;
						startSession();
					}
				}

				const startSession = () => {
					const offer = btoa(JSON.stringify(pc.localDescription));
					fetch('/connect', {
							method: 'POST',
							body: offer,
					})
					.then((res) => {
						if (!res.ok) {
							throw Error(res.statusText);
						}
						return res.text();
					})
					.then((answer) => {
						const d = new RTCSessionDescription(JSON.parse(atob(answer)));
						return pc.setRemoteDescription(d);
					})
					.catch((e) => log(`Connection error: ${e}`));
				}
	</script>
	<body>
			<div id="remoteVideos">
				<h1 id="loading">Loading...</h1>
			</div>
	</body>
</html>